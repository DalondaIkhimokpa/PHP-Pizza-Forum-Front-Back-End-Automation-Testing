name: Smoke Test

on: [push]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - uses: actions/checkout@v4

      - name: Verify PHP files exist
        run: |
          echo "Checking critical files:"
          ls -la templates/add.php
          ls -la config/conn_db.php
          ls -la index.php
          [ -f templates/add.php ] || exit 1
          [ -f config/conn_db.php ] || exit 1
          [ -f index.php ] || exit 0 # index.php is optional for this test

      - name: Verify database connection
        run: |
          sudo apt-get update
          sudo apt-get install -y php mysql-client
          php -r '
            $conn = new mysqli(
              getenv("DB_HOST") ?: "127.0.0.1",
              getenv("DB_USER") ?: "demo", 
              getenv("DB_PASSWORD") ?: "test1234",
              getenv("DB_NAME") ?: "pizza_forum"
            );
            if ($conn->connect_error) {
              echo "CONNECTION FAILED: " . $conn->connect_error;
              exit(1);
            }
            echo "CONNECTION SUCCESS!";
            $conn->close();
          '
        env:
          DB_HOST: 127.0.0.1
          DB_USER: demo
          DB_PASSWORD: test1234
          DB_NAME: pizza_forum